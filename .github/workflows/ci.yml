name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-test-coverage:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            7.0.x

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      # ---------- BUILD ----------
      - name: Build (Release) — Windows (all)
        if: matrix.os == 'windows-latest'
        run: dotnet build --configuration Release --no-restore

      - name: Build (Release) — Ubuntu (subset no-Windows)
        if: matrix.os == 'ubuntu-latest'
        run: |
          dotnet build src/ProgesiCore/ProgesiCore.csproj --configuration Release --no-restore
          dotnet build src/ProgesiRepositories.Sqlite/ProgesiRepositories.Sqlite.csproj --configuration Release --no-restore
          dotnet build src/ProgesiRepositories.InMemory/ProgesiRepositories.InMemory.csproj --configuration Release --no-restore
          # Skipped on Ubuntu:
          # - src/ProgesiRepositories.Rhino
          # - src/ProgesiGrasshopperAssembly
          # - tools/ProgesiDbMaint

      # ---------- TEST + COVERAGE (solo Windows) ----------
      - name: Test + Coverage (XPlat)
        if: matrix.os == 'windows-latest'
        run: >
          dotnet test
          --configuration Release
          --no-build
          --collect:"XPlat Code Coverage"
          --results-directory TestResults

      - name: Install reportgenerator
        if: matrix.os == 'windows-latest'
        run: dotnet tool update --global dotnet-reportgenerator-globaltool

      - name: Generate Coverage Report (ProgesiCore only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $reports = Get-ChildItem -Recurse -Path "TestResults" -Filter "coverage.cobertura.xml" | % { $_.FullName }
          if (-not $reports) { Write-Error "Nessun report Cobertura trovato in TestResults"; exit 1 }
          $reportsArg = ($reports -join ";")
          reportgenerator `
            -reports:$reportsArg `
            -targetdir:"CoverageReport" `
            -reporttypes:"Html;TextSummary;Cobertura" `
            -assemblyfilters:"+ProgesiCore" `
            -classfilters:"-*Logger*;-*LegacyExtensions*;-*TraceLogger*"
          if (-not (Test-Path "CoverageReport/Summary.txt")) { Write-Error "Summary.txt non generato"; exit 1 }
          Write-Host "----- Coverage Summary (ProgesiCore only) -----"
          Get-Content "CoverageReport/Summary.txt" | Write-Host

      - name: Compare with baseline (warn-only)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not (Test-Path "CoverageReport/Summary.txt")) { Write-Warning "Summary.txt non trovato"; exit 0 }
          $summary = Get-Content -Raw "CoverageReport/Summary.txt"
          $line   = if ($summary -match 'Line coverage:\s*([\d\.]+)%')   { [double]$Matches[1] } else { 0 }
          $branch = if ($summary -match 'Branch coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          $method = if ($summary -match 'Method coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          if (Test-Path "tests/coverage-baseline.json") {
            $baseline = Get-Content -Raw "tests/coverage-baseline.json" | ConvertFrom-Json
            $dLine   = [math]::Round($line   - [double]$baseline.line,   1)
            $dBranch = [math]::Round($branch - [double]$baseline.branch, 1)
            $dMethod = [math]::Round($method - [double]$baseline.method, 1)
            Write-Host ("Δ vs baseline -> line {0:+0.0;-0.0;±0.0} / branch {1:+0.0;-0.0;±0.0} / method {2:+0.0;-0.0;±0.0}" -f $dLine,$dBranch,$dMethod)
          } else {
            Write-Warning "Baseline non trovata (tests/coverage-baseline.json)"
          }

      - name: Enforce minimum coverage thresholds
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $s = Get-Content -Raw "CoverageReport/Summary.txt"
          if (-not $s) { Write-Error "Summary.txt non trovato"; exit 1 }
          $line   = if ($s -match 'Line coverage:\s*([\d\.]+)%')   { [double]$Matches[1] } else { 0 }
          $branch = if ($s -match 'Branch coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          $method = if ($s -match 'Method coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          $minLine = 95.0; $minBranch = 80.0; $minMethod = 94.0
          Write-Host ("Thresholds -> Line≥{0} Branch≥{1} Method≥{2}" -f $minLine,$minBranch,$minMethod)
          $ok = ($line -ge $minLine) -and ($branch -ge $minBranch) -and ($method -ge $minMethod)
          if (-not $ok) {
            Write-Error ("Coverage below thresholds: line={0:N1} branch={1:N1} method={2:N1}" -f $line,$branch,$method)
            exit 1
          }
          Write-Host ("OK: {0:N1}/{1:N1}/{2:N1} meet thresholds" -f $line,$branch,$method)

      - name: Generate coverage badge (SVG)
        if: matrix.os == 'windows-latest' && github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          ./tools/Generate-CoverageBadge.ps1 -SummaryPath "CoverageReport/Summary.txt" -OutPath "docs/badges/coverage-core.svg"

      - name: Commit badge to repo
        if: matrix.os == 'windows-latest' && github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(badge): update coverage badge (ProgesiCore)"
          file_pattern: docs/badges/coverage-core.svg

      - name: Upload coverage artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          path: CoverageReport

      - name: Comment coverage summary on PR
        if: matrix.os == 'windows-latest' && github.event_name == 'pull_request'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          $s = Get-Content -Raw "CoverageReport/Summary.txt"
          if (-not $s) { Write-Error "Summary.txt non trovato"; exit 1 }
          $line   = if ($s -match 'Line coverage:\s*([\d\.]+)%')   { [double]$Matches[1] } else { 0 }
          $branch = if ($s -match 'Branch coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          $method = if ($s -match 'Method coverage:\s*([\d\.]+)%') { [double]$Matches[1] } else { 0 }
          if (Test-Path "tests/coverage-baseline.json") {
            $baseline = Get-Content -Raw "tests/coverage-baseline.json" | ConvertFrom-Json
          } else {
            $baseline = @{ line = 0.0; branch = 0.0; method = 0.0 } | ConvertTo-Json | ConvertFrom-Json
          }
          $dLine   = [math]::Round($line   - [double]$baseline.line,   1)
          $dBranch = [math]::Round($branch - [double]$baseline.branch, 1)
          $dMethod = [math]::Round($method - [double]$baseline.method, 1)
          function FmtDelta([double]$v) {
            if     ($v -gt 0){ return "+$($v.ToString('0.0'))" }
            elseif ($v -lt 0){ return  $v.ToString('0.0') }
            else  { return "±0.0" }
          }
          $bodyLines = @(
            "### ✅ Coverage summary (ProgesiCore)",
            "",
            ("**Line:**   {0:N1}% ({1} vs baseline {2:N1}%)" -f $line,   (FmtDelta $dLine),   $baseline.line),
            ("**Branch:** {0:N1}% ({1} vs baseline {2:N1}%)" -f $branch, (FmtDelta $dBranch), $baseline.branch),
            ("**Method:** {0:N1}% ({1} vs baseline {2:N1}%)" -f $method, (FmtDelta $dMethod), $baseline.method),
            "",
            "_Report from `CoverageReport/Summary.txt`._"
          )
          $body = $bodyLines -join [Environment]::NewLine
          Set-Content -Path pr-comment.md -Value $body -NoNewline -Encoding UTF8
          gh pr comment $env:PR_NUMBER --body-file pr-comment.md
