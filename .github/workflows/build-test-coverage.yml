name: build-test-coverage

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: windows-latest
    env:
      SLNF: ${{ github.workspace }}\Progesi.CI.slnf

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET (8.x)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x

      - name: NuGet cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: Windows-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            Windows-nuget-

      - name: Restore (solution filter)
        run: dotnet restore "$Env:SLNF"

      - name: Check formatting
        run: dotnet format whitespace "$Env:SLNF" --verify-no-changes

      - name: Build (Release)
        run: dotnet build "$Env:SLNF" -c Release --no-restore

      # Coverage sui test Core
      - name: Test – ProgesiCore.Tests (coverage)
        run: >
          dotnet test tests/ProgesiCore.Tests/ProgesiCore.Tests.csproj
          -c Release
          --collect:"XPlat Code Coverage"
          --logger "trx;LogFileName=ProgesiCore.Tests.trx"
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      # ===== Sqlite: restore + build + test (RID) =====
      - name: Restore – ProgesiRepositories.Sqlite.Tests (RID win-x64)
        run: dotnet restore tests/ProgesiRepositories.Sqlite.Tests/ProgesiRepositories.Sqlite.Tests.csproj -r win-x64

      - name: Build – ProgesiRepositories.Sqlite.Tests (RID win-x64)
        run: >
          dotnet build tests/ProgesiRepositories.Sqlite.Tests/ProgesiRepositories.Sqlite.Tests.csproj
          -c Release -r win-x64 --no-restore

      - name: Test – ProgesiRepositories.Sqlite.Tests (coverage, RID win-x64)
        run: >
          dotnet test tests/ProgesiRepositories.Sqlite.Tests/ProgesiRepositories.Sqlite.Tests.csproj
          -c Release -r win-x64 --no-build
          --collect:"XPlat Code Coverage"
          --logger "trx;LogFileName=ProgesiRepositories.Sqlite.Tests.trx"
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
      # ================================================

      - name: Elenco TestResults (debug)
        shell: pwsh
        run: |
          Write-Host 'Listing TestResults:'
          Get-ChildItem -Recurse -Force "$PWD/TestResults" | ForEach-Object { Write-Host $_.FullName }
          Write-Host 'Listing coverage.cobertura.xml:'
          Get-ChildItem -Recurse -Force "$PWD/TestResults" -Filter coverage.cobertura.xml | ForEach-Object { Write-Host $_.FullName }

      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@v5
        with:
          reports: "**/TestResults/**/coverage.cobertura.xml"
          targetdir: CoverageReport
          reporttypes: Html;TextSummary;Cobertura
          historydir: CoverageHistory
          assemblyfilters: "+ProgesiCore;+ProgesiRepositories.*"
          classfilters: "-*Logger*;-*LegacyExtensions*;-*TraceLogger*"
          filefilters: "+*"
          verbosity: Info

      - name: Upload CoverageReport
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          path: CoverageReport/**

      - name: Upload TestResults
        uses: actions/upload-artifact@v4
        with:
          name: TestResults
          path: TestResults/**
