name: build-test-coverage

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  coverage:
    name: build-test-coverage
    runs-on: windows-latest
    env:
      # Soglia CI. Ora 79% per far passare stabilmente (attuale ~79.4%).
      # Quando saliamo oltre 80% in modo consistente, porta questo valore a 80.
      COVERAGE_MIN: "79"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (LTS runtime + SDK 8.x)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
          dotnet-quality: ga

      - name: Install ReportGenerator (global tool)
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Add .dotnet tools to PATH
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Run tests + merge coverage (Cobertura + TextSummary)
        shell: pwsh
        run: pwsh ./tools/coverage.ps1 -RunTests

      - name: Gate coverage
        shell: pwsh
        run: pwsh ./tools/coverage.ps1 -MinLine $env:COVERAGE_MIN

      - name: Hotspots (Top 20) â†’ Step Summary
        if: always()
        shell: pwsh
        run: |
          "## Coverage hotspots (Top 20)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          pwsh ./tools/coverage-hotspots.ps1 -Cobertura "TestResults/MergedCoverage/Cobertura.xml" -Top 20 | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Generate HTML coverage report
        if: always()
        shell: pwsh
        run: |
          reportgenerator `
            -reports:"TestResults/MergedCoverage/Cobertura.xml" `
            -targetdir:"CoverageReport" `
            -reporttypes:"HtmlInline_AzurePipelines"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          if-no-files-found: warn
          path: |
            TestResults/MergedCoverage/Cobertura.xml
            TestResults/MergedCoverage/Summary.txt
            CoverageReport/**
